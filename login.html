<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>test social media</title>
  <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>
<body>
    <button class="btn redirect">redirect</button>
  <button class="btn reflash">reflash</button>
  <button class="btn fbLogin">fbLogin</button>
  <button class="btn googleLogin">googleLogin</button>
  <p class="version"></p>
  <div class="content">

  </div>
</body>

<script>
  var version = 'v87';
  var search = location.search;
  var isNotRightUrl = search.indexOf('version=' + version) === -1;
  if (isNotRightUrl) {
    var islocationSearch = location.search !== '';
    var locationSearch = '';
    if (islocationSearch) {
      locationSearch = location.search.replace('?', '') + '&version=' + version;
    } else {
      locationSearch = 'version=' + version;
    }
    location.href = location.origin + location.pathname + '?' + locationSearch;
  }
  $('.version').html(version);
  $('.content').append('url:' + location.href + '</br>');
  $('.reflash').on('click', function() {
    var time = new Date().getTime();
    location.href = location.origin + location.pathname + '?time=' + time;
  });
  $('.redirect').on('click', function() {
    location.href = 'login.html?fbback=1';
  });

  /* =========================================================================== */

  window.fbAsyncInit = () => {
    FB.init({
      appId            : '309850763221643',
      autoLogAppEvents : true,
      xfbml            : true,
      version          : 'v3.2',
      status: true,
    });
  };

  (function(d, s, id){
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "https://connect.facebook.net/en_US/sdk.js";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));

  $('.fbLogin').on('click', function() {
    location.href = 'https://www.facebook.com/v3.2/dialog/oauth?client_id=309850763221643&redirect_uri=https://ml-andy.github.io/20190219_iphoneX/login.html?fbback=1';

    // fbLogin(function(obj) {
    //   $('.content').append('email:' + obj.email + '</br>');
    //   $('.content').append('url:' + location.href + '</br>');
    // });
  });

  function fbLogin(fn) {
    var options = {
      scope: 'email',
      return_scopes: true,
      auth_type: 'rerequest',
    };

    FB.login((response) => {
      var { authResponse = null } = response;
      var grantedScopes = authResponse ? authResponse['grantedScopes'] : '';
      var isAuthEmail = grantedScopes.indexOf('email') >= 0;

      if (authResponse && isAuthEmail) {
        FB.api('/me?fields=email', function(response) {
          var success = response.email ? true : false;
          var status_id = success ? '' : 'SOCIALMEDIA_E003';
          fn({
            success,
            email: response.email,
            status_id,
          });
        });
      } else {
        var status_id = authResponse
          ? 'SOCIALMEDIA_E002'
          : 'SOCIALMEDIA_E001';
        fn({ status_id });
      }
    }, options);
  }

  /* =========================================================================== */
  
  var googleAuth2;
  window.googleAsyncInit = () => {
    gapi.load('auth2', () => {
      googleAuth2 = gapi.auth2.init({
        client_id: '928083793508-vob9ugvrdlcl6nspdeko8gtm991f8557.apps.googleusercontent.com',
        scope: 'email'
      });
    });
  }

  (function(d, s, id){
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) {return;}
    js = d.createElement(s); js.id = id;
    js.src = "https://apis.google.com/js/client:platform.js?onload=googleAsyncInit";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'google-jssdk'));

  $('.googleLogin').on('click', function() {
    // mobile
    location.href = 'https://accounts.google.com/o/oauth2/v2/auth?client_id=928083793508-vob9ugvrdlcl6nspdeko8gtm991f8557.apps.googleusercontent.com&redirect_uri=https://ml-andy.github.io/20190219_iphoneX/login.html&response_type=code&scope=email';
    
    // desktop
    // googleLogin();
  });

  function googleLogin() {
    googleAuth2
      .signIn()
      .then(() => {
        var profile = googleAuth2.currentUser.get().getBasicProfile();
        var email = profile.getEmail();
        console.log(email);
      })
      .catch((error) => {
        console.log(error);
      });
  }

  /* =========================================================================== */

  var search = location.search;
  if (search.indexOf('fbback') !== -1) {
    $('.content').append('fb login back</br>');
    // fbLogin(function(obj) {
    //   $('.content').append('email:' + obj.email + '</br>');
    //   $('.content').append('url:' + location.href + '</br>');
    // });
  } else if (search.indexOf('googleback') !== -1) {
    $('.content').append('google login back</br>');
  }

</script>
</html>